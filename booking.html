<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book Auto - Mumbai Share Auto</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="css/booking.css">
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDemoKey"></script>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="nav-container">
      <a href="index.html" class="logo">ShareRickshaw</a>
      <ul class="nav-links">
        <li><a href="index.html" class="nav-link">Home</a></li>
        <li><a href="fare-calculator.html" class="nav-link">Fare</a></li>
        <li><a href="stands-map.html" class="nav-link">Stands</a></li>
        <li><a href="route-finder.html" class="nav-link">Routes</a></li>
        <li><a href="booking.html" class="nav-link active">Booking</a></li>
        <li><a href="safety.html" class="nav-link">Safety</a></li>
        <li><a href="#" id="logoutBtn" class="nav-link">Logout</a></li>
      </ul>
    </div>
  </nav>

  <!-- Mobile Menu -->
  <div class="mobile-menu">
    <button class="menu-close">&times;</button>
    <ul class="mobile-menu-links">
      <li><a href="index.html">Home</a></li>
      <li><a href="fare-calculator.html">Fare</a></li>
      <li><a href="stands-map.html">Stands</a></li>
      <li><a href="route-finder.html">Routes</a></li>
      <li><a href="booking.html" class="active">Booking</a></li>
      <li><a href="safety.html">Safety</a></li>
      <li><a href="#" id="logoutBtnMobile">Logout</a></li>
    </ul>
  </div>

  <!-- Main Content -->
  <main class="booking-container">
    <!-- Section 1: Booking Request Form -->
    <section id="bookingForm" class="booking-section active">
      <div class="form-container">
        <h1>Request a Ride</h1>

        <form id="rideRequestForm">
          <div class="form-group">
            <label for="pickupAddress">Pickup Location</label>
            <input type="text" id="pickupAddress" name="pickupAddress" placeholder="Enter pickup address" required>
            <button type="button" id="useMyLocationBtn" class="location-btn">üìç Use My Location</button>
            <div class="error-message" id="pickupAddressError"></div>
            <input type="hidden" id="pickupLatitude" name="pickupLatitude">
            <input type="hidden" id="pickupLongitude" name="pickupLongitude">
          </div>

          <div class="form-group">
            <label for="destinationAddress">Destination</label>
            <input type="text" id="destinationAddress" name="destinationAddress" placeholder="Enter destination address" required>
            <button type="button" id="pickOnMapBtn" class="location-btn">üó∫Ô∏è Pick on Map</button>
            <div class="error-message" id="destinationAddressError"></div>
            <input type="hidden" id="destinationLatitude" name="destinationLatitude">
            <input type="hidden" id="destinationLongitude" name="destinationLongitude">
          </div>

          <div class="form-group">
            <label for="estimatedFare">Estimated Fare</label>
            <div class="fare-display">
              <span id="fareAmount">‚Çπ0</span>
              <input type="hidden" id="estimatedFare" name="estimatedFare" value="0">
            </div>
          </div>

          <button type="submit" class="btn btn-primary" id="requestRideBtn">Request Ride</button>
          <div class="error-message" id="formError"></div>
        </form>
      </div>
    </section>

    <!-- Section 2: Booking Status - Waiting for Driver -->
    <section id="bookingStatus" class="booking-section hidden">
      <div class="status-container">
        <div class="spinner"></div>
        <h2>Waiting for driver to accept...</h2>

        <div class="booking-details">
          <div class="detail-item">
            <span class="label">Pickup:</span>
            <span id="statusPickup" class="value">-</span>
          </div>
          <div class="detail-item">
            <span class="label">Destination:</span>
            <span id="statusDestination" class="value">-</span>
          </div>
          <div class="detail-item">
            <span class="label">Estimated Fare:</span>
            <span id="statusFare" class="value">‚Çπ0</span>
          </div>
          <div class="detail-item">
            <span class="label">Booking ID:</span>
            <span id="statusBookingId" class="value">-</span>
          </div>
        </div>

        <button type="button" id="cancelBookingBtn" class="btn btn-danger">Cancel Booking</button>
      </div>
    </section>

    <!-- Section 3: Active Booking - Driver Info & Map -->
    <section id="activeBooking" class="booking-section hidden">
      <div class="active-booking-layout">
        <!-- Map Container -->
        <div id="mapContainer" class="map-container">
          <div id="map"></div>
          <div class="booking-status-card">
            <h3 id="tripStatus">Driver on the way</h3>
            <div id="driverDistance" class="eta" style="color: #FF6B6B; font-weight: bold; margin: 0.5rem 0;">üìç Distance: Calculating...</div>
            <div id="eta" class="eta">‚è±Ô∏è ETA: Calculating...</div>
          </div>
        </div>

        <!-- Driver Info Card -->
        <div class="driver-info-card">
          <div class="driver-header">
            <h3>Your Driver</h3>
            <button type="button" id="closeDriverCardBtn" class="close-btn">&times;</button>
          </div>
          <div class="driver-details">
            <div class="driver-name" id="driverName">Driver Name</div>
            <div class="driver-plate" id="licenseePlate">License Plate</div>
            <div class="driver-rating">
              <span id="driverRating">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
            </div>
          </div>
        </div>

        <!-- Chat Panel -->
        <div id="chatPanel" class="chat-panel">
          <div class="chat-header">
            <h3>Chat with Driver</h3>
            <button type="button" id="closeChatBtn" class="close-btn">&times;</button>
          </div>
          <div id="messagesList" class="messages-list"></div>
          <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Type a message..." maxlength="500">
            <button type="button" id="sendMessageBtn" class="btn btn-small">Send</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Section 4: Trip Completed State -->
    <section id="tripCompleted" class="booking-section hidden">
      <div class="completion-container">
        <div class="success-icon">‚úì</div>
        <h2>Trip Completed!</h2>

        <div class="trip-summary">
          <div class="summary-item">
            <span class="label">Start Time:</span>
            <span id="startTime" class="value">-</span>
          </div>
          <div class="summary-item">
            <span class="label">End Time:</span>
            <span id="endTime" class="value">-</span>
          </div>
          <div class="summary-item">
            <span class="label">Duration:</span>
            <span id="tripDuration" class="value">-</span>
          </div>
          <div class="summary-item">
            <span class="label">Fare:</span>
            <span id="tripFare" class="value">‚Çπ0</span>
          </div>
        </div>

        <div class="action-buttons">
          <button type="button" id="rateDriverBtn" class="btn btn-secondary">Rate Driver</button>
          <button type="button" id="newRideBtn" class="btn btn-primary">Request New Ride</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Map Selection Modal -->
  <div id="mapModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Select Location</h2>
        <button type="button" class="close-btn" id="closeMapModal">&times;</button>
      </div>
      <div id="mapModalMap" class="map-modal"></div>
      <div class="modal-footer">
        <button type="button" id="confirmMapBtn" class="btn btn-primary">Confirm</button>
        <button type="button" id="cancelMapBtn" class="btn btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="js/auth.js"></script>
  <script src="js/booking.js"></script>
  <script src="js/bookingSocket.js"></script>
  <script>
  // Check authentication and user role immediately
  if (!window.isLoggedIn()) {
    window.location.href = 'login.html';
  } else {
    // Check if user is regular user (not autowala)
    const userData = window.getUserData();
    if (!userData || userData.role !== 'user') {
      window.location.href = 'index.html';
    }
  }
  </script>
</body>
</html>
